---
title: "LAB"
output: github_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## lab
# I. Introduction
The proposed open-source lab package is a software tool that help users to explore and process laboratory data in electronic health records (EHRs). With the lab package, researchers can easily map local laboratory codes to the universal standard, mark abnormal results, summarize data using descriptive statistics, impute missing values, and generate analysis ready data.

## Feature
- **Data Mapping** Standardize and manipulate data with Logical Observation Identifiers Names and Codes (LOINC), a common terminology for laboratory and clinical observations. 
- **Time Series Analysis** Separate lab test results into multiple consecutive non-overlapped time windows
- **Value Imputation** Impute value to replace missing data
- **Wide Format Generation** Transform longitudinal data into wide format to generate analysis ready data

## Development version

```r
# install.packages("devtools")
devtools::install_github("DHLab-TSENG/dxpr")
```

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = T, comment = "#>")
options(tibble.print_min = 4L, tibble.print_max = 4L)
#devtools::install_github("DHLab-TSENG/lab")
library(lab)
```

## Overview

<img src="https://raw.githubusercontent.com/DHLab-TSENG/lab/master/image/overview.png" style="display:block; margin:auto; width:100%;">


## Usage

```r
# install.packages("devtools")
devtools::install_github("DHLab-TSENG/lab")
library(lab)
```

### Dataset

The sample data includes 1,744 lab records containing 7 different lab items tested by 5 patients from MIMIC-III database.

```{r, message = FALSE, warning = FALSE}

head(labSample)

head(mapSample)
```


### I. Data Mapping

If LOINC is not the default terminology, users are recommended to map local lab item with LOINC by providing mapping table. Once a user map lab test codes with LOINC, ranges can be used to mark abnormal results, and related names can be used to search related lab test codes by other common names of a lab test.

```{r, message = FALSE, warning = FALSE}

loincSample <- mapLOINC(labData = labSample, labItemColName = ITEMID, mappingTable = mapSample)

head(loincSample)

loincMarkedSample <- getAbnormalMark(labData = loincSample, 
                                     idColName = SUBJECT_ID,
                                     labItemColName = LOINC, 
                                     valueColName = VALUENUM, 
                                     genderColName = GENDER,
                                     genderTable = patientSample,
                                     referenceTable = refLOINC)
head(loincMarkedSample)
```

# II. Time Series Overview

```
windowProportion <- plotWindowProportion(labData = loincSample, 
                     idColName = SUBJECT_ID, 
                     labItemColName = LOINC, 
                     dateColName = CHARTTIME, 
                     indexDate = first, 
                     gapDate = c(30, 90, 180, 360), 
                     topN = 5)

print(windowProportion$graph)

print(windowProportion$missingData)


timeSeriesData <- getTimeSeriesLab(labData = loincSample,
                                   idColName = SUBJECT_ID,
                                   labItemColName = LOINC + CATEGORY,
                                   dateColName = CHARTTIME,
                                   valueColName = VALUENUM,
                                   indexDate = first,
                                   gapDate = 30,
                                   completeWindows = TRUE)
head(timeSeriesData)

fullTimeSeriesData <- imputeTimeSeriesLab(labData = timeSeriesData,
                                   idColName = ID,
                                   labItemColName = LOINC + CATEGORY,
                                   windowColName = Window,
                                   valueColName = Mean & Nearest,
                                   impMethod = NOCB)
head(fullTimeSeriesData)

timeSeriesPlot <- plotTimeSeriesLab(labData = fullTimeSeriesData, 
                                    idColName = ID, 
                                    labItemColName = LOINC + CATEGORY, 
                                    timeMarkColName = Window, 
                                    valueColName = Nearest, 
                                    timeStart = 1, 
                                    timeEnd  = 5, 
                                    abnormalMarkColName = NULL)

plot(timeSeriesPlot)

wideTimeSeriesData <- wideTimeSeriesLab(labData = fullTimeSeriesData,
                                        idColName = ID,
                                        labItemColName = LOINC + CATEGORY,
                                        windowColName = Window, 
                                        valueColName = Nearest)
head(wideTimeSeriesData)

```
<!-- ## Visulization -->

<!-- The plot -->

<!-- ```{r pressure, echo=FALSE} -->
<!-- plot(pressure) -->
<!-- ``` -->

